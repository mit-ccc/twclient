<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mutual Followers and Friends &mdash; twclient 0.2.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" src="../../_static/jquery.js"></script>
        <script integrity="sha384-lSZeSIVKp9myfKbDQ3GkN/KHjUc+mzg17VKDN4Y2kUeBSJioB9QSM639vM9fuY//" src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="API Documentation" href="../../apidocs.html" />
    <link rel="prev" title="User-Level Information: Bio, Location, Etc." href="user-info.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            twclient
          </a>
              <div class="version">
                0.2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/readme.html">README</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/license.html">Apache License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Vignettes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../fetch.html">Getting data from the Twitter API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../export.html">Working with fetched data</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../export.html#built-in-exports">Built-in exports</a></li>
<li class="toctree-l2"><a class="reference internal" href="../export.html#custom-sql">Custom SQL</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../export.html#sql-examples">SQL Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="follow-graph.html">Follow Graph</a></li>
<li class="toctree-l3"><a class="reference internal" href="tweets.html">Users’ Tweets</a></li>
<li class="toctree-l3"><a class="reference internal" href="tweet-graphs.html">Tweet-Derived Graphs: Mention, Reply, Retweet, Quote</a></li>
<li class="toctree-l3"><a class="reference internal" href="user-info.html">User-Level Information: Bio, Location, Etc.</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Mutual Followers and Friends</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../apidocs.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">twclient</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../export.html">Working with fetched data</a></li>
      <li class="breadcrumb-item active">Mutual Followers and Friends</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/vignettes/sql-exports/mutual-followers-friends-counts.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mutual-followers-and-friends">
<h1>Mutual Followers and Friends<a class="headerlink" href="#mutual-followers-and-friends" title="Permalink to this heading"></a></h1>
<p>One question that sometimes arises about a pair of Twitter users is how many
followers or friends <a class="footnote-reference brackets" href="#id3" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> they have in common. There are several reasons you
might want to know this, including that it provides an indication of
between-user similarity. If you’ve <a class="reference internal" href="../fetch.html"><span class="doc">fetched</span></a>
follow-graph data, you can compute the number of mutual friends or followers
for a pair of users or all pairs of users in SQL.</p>
<p>How might we go about this? First, let’s ask how to find the list of a user’s
followers at all. Using user ID 123 for illustration, we might run this query,
where <code class="docutils literal notranslate"><span class="pre">source_user_id</span></code> means we’re asking for the followers of
<code class="docutils literal notranslate"><span class="pre">target_user_id</span></code> 123:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
<span class="w">    </span><span class="n">source_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">follow</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">    </span><span class="n">target_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="p">;</span>
</pre></div>
</div>
<p>Not too hard! Do note, though,  that in this query and throughout the rest of
this vignette, we’ll consider only currently valid followers, not previously
valid follow edges which expired when one user unfollowed another. To implement
this restriction, various WHERE clauses will require that <code class="docutils literal notranslate"><span class="pre">valid_end_dt</span> <span class="pre">is</span>
<span class="pre">null</span></code> — see the vignette on the <a class="reference internal" href="follow-graph.html"><span class="doc">follow graph</span></a> for more information.</p>
<p>But how do we get the subset of this group which also follows, say, user 456?
One way is to rely on SQL’s <code class="docutils literal notranslate"><span class="pre">INTERSECT</span></code> feature, which calculates the set
intersection of two resultsets:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
<span class="w">    </span><span class="n">source_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">follow</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">    </span><span class="n">target_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span>

<span class="w"> </span><span class="k">intersect</span><span class="w"> </span><span class="k">all</span>

<span class="k">select</span>
<span class="w">    </span><span class="n">source_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="k">from</span><span class="w"> </span><span class="n">follow</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">    </span><span class="n">target_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">456</span><span class="p">;</span>
</pre></div>
</div>
<p>We use <code class="docutils literal notranslate"><span class="pre">INTERSECT</span> <span class="pre">ALL</span></code> rather than <code class="docutils literal notranslate"><span class="pre">INTERSECT</span></code> because it’s not necessary
to deduplicate the results: only one row can be marked valid for a given
(<code class="docutils literal notranslate"><span class="pre">source_user_id</span></code>, <code class="docutils literal notranslate"><span class="pre">target_user_id</span></code>) pair at once.</p>
<p>Now, how would we get the count of how many users this query returns? Again,
it’s not too big a leap: just use a subquery:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
<span class="w">    </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cnt</span>
<span class="k">from</span>
<span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">source_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">follow</span>
<span class="w">    </span><span class="k">where</span>
<span class="w">        </span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">        </span><span class="n">target_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span>

<span class="w">     </span><span class="k">intersect</span><span class="w"> </span><span class="k">all</span>

<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">source_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">follow</span>
<span class="w">    </span><span class="k">where</span>
<span class="w">        </span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">        </span><span class="n">target_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">456</span>
<span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
</pre></div>
</div>
<p>What if we wanted to do this for every user in a specific set, such as those
tagged “universe”? (See the <a class="reference internal" href="../fetch.html"><span class="doc">fetching data vignette</span></a> for
a disucssion of the tagging feature.) We can retrieve the set of tagged users
as follows:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
<span class="w">    </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">from</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="c1">-- standard sql reserves this table name, need to quote it</span>
<span class="w">    </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">user_tag</span><span class="w"> </span><span class="n">ut</span><span class="w"> </span><span class="k">using</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="n">ta</span><span class="w"> </span><span class="k">using</span><span class="p">(</span><span class="n">tag_id</span><span class="p">)</span>
<span class="k">where</span>
<span class="w">    </span><span class="c1">-- just an example of using tagging, a tag</span>
<span class="w">    </span><span class="c1">-- with this name is not created automatically</span>
<span class="w">    </span><span class="n">ta</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;universe&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>And combine it with the mutual-followers query above like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span><span class="w"> </span><span class="n">tmp_universe</span><span class="w"> </span><span class="k">as</span>
<span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="w"> </span><span class="n">u</span>
<span class="w">        </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">user_tag</span><span class="w"> </span><span class="n">ut</span><span class="w"> </span><span class="k">using</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="w">        </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="n">ta</span><span class="w"> </span><span class="k">using</span><span class="p">(</span><span class="n">tag_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">where</span>
<span class="w">        </span><span class="n">ta</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;universe&#39;</span>
<span class="p">)</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">ut1</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id1</span><span class="p">,</span>
<span class="w">    </span><span class="n">ut2</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id2</span><span class="p">,</span>

<span class="w">    </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span>
<span class="w">            </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cnt</span>
<span class="w">        </span><span class="k">from</span>
<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="k">select</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">source_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">follow</span><span class="w"> </span><span class="n">fo</span>
<span class="w">            </span><span class="k">where</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">target_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ut1</span><span class="p">.</span><span class="n">user_id</span>

<span class="w">            </span><span class="k">intersect</span><span class="w"> </span><span class="k">all</span>

<span class="w">            </span><span class="k">select</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">source_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">follow</span><span class="w"> </span><span class="n">fo</span>
<span class="w">            </span><span class="k">where</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">target_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ut2</span><span class="p">.</span><span class="n">user_id</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">mutual_followers</span>
<span class="k">from</span><span class="w"> </span><span class="n">tmp_universe</span><span class="w"> </span><span class="n">ut1</span>
<span class="w">    </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">tmp_universe</span><span class="w"> </span><span class="n">ut2</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">ut1</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ut2</span><span class="p">.</span><span class="n">user_id</span><span class="p">;</span>
</pre></div>
</div>
<p>This query looks complicated but adds only one thing over the versions above.
The FROM clause generates all pairs of user IDs, unique up to order <a class="footnote-reference brackets" href="#id4" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>, and
the innermost pair of queries fed into the <code class="docutils literal notranslate"><span class="pre">INTERSECT</span></code> select the sets of
followers of each element in a given pair. (By referring to <code class="docutils literal notranslate"><span class="pre">ut1.user_id</span></code> and
<code class="docutils literal notranslate"><span class="pre">ut2.user_id</span></code> rather than the specific values 123 and 456.) Because the
subquery that generates the count of mutual followers appears in the SELECT
list of columns, the one value it returns appears in the final resultset along
with the pair of user IDs it corresponds to.</p>
<p>This is an example of a <a class="reference external" href="https://en.wikipedia.org/wiki/Correlated_subquery">correlated
subquery</a>. It’s just
doing iteration in SQL: the DBMS executes the subquery once for each row in the
FROM clause, which is to say once for each pair of users, and concatenates the
results. Accordingly this query has to do <span class="math notranslate nohighlight">\(O(n^2)\)</span> subqueries if there
are <span class="math notranslate nohighlight">\(n\)</span> users, and may be quite slow, especially if some users have large
numbers of followers.</p>
<p>Finally, how would we change it to get the number of mutual friends? Simple:
just swap references to <code class="docutils literal notranslate"><span class="pre">source_user_id</span></code> and <code class="docutils literal notranslate"><span class="pre">target_user_id</span></code>.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">with</span><span class="w"> </span><span class="n">tmp_universe</span><span class="w"> </span><span class="k">as</span>
<span class="p">(</span>
<span class="w">    </span><span class="k">select</span>
<span class="w">        </span><span class="n">u</span><span class="p">.</span><span class="n">user_id</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="w"> </span><span class="n">u</span>
<span class="w">        </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">user_tag</span><span class="w"> </span><span class="n">ut</span><span class="w"> </span><span class="k">using</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="w">        </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="n">ta</span><span class="w"> </span><span class="k">using</span><span class="p">(</span><span class="n">tag_id</span><span class="p">)</span>
<span class="w">    </span><span class="k">where</span>
<span class="w">        </span><span class="n">ta</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;universe&#39;</span>
<span class="p">)</span>
<span class="k">select</span>
<span class="w">    </span><span class="n">ut1</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id1</span><span class="p">,</span>
<span class="w">    </span><span class="n">ut2</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id2</span><span class="p">,</span>

<span class="w">    </span><span class="p">(</span>
<span class="w">        </span><span class="k">select</span>
<span class="w">            </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="w">        </span><span class="k">from</span>
<span class="w">        </span><span class="p">(</span>
<span class="w">            </span><span class="k">select</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">target_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">follow</span><span class="w"> </span><span class="n">fo</span>
<span class="w">            </span><span class="k">where</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">source_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ut1</span><span class="p">.</span><span class="n">user_id</span>

<span class="w">            </span><span class="k">intersect</span><span class="w"> </span><span class="k">all</span>

<span class="w">            </span><span class="k">select</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">target_user_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span>
<span class="w">            </span><span class="k">from</span><span class="w"> </span><span class="n">follow</span><span class="w"> </span><span class="n">fo</span>
<span class="w">            </span><span class="k">where</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">valid_end_dt</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">and</span>
<span class="w">                </span><span class="n">fo</span><span class="p">.</span><span class="n">source_user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ut2</span><span class="p">.</span><span class="n">user_id</span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">mutual_friends</span>
<span class="k">from</span><span class="w"> </span><span class="n">tmp_universe</span><span class="w"> </span><span class="n">ut1</span>
<span class="w">    </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">tmp_universe</span><span class="w"> </span><span class="n">ut2</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">ut1</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ut2</span><span class="p">.</span><span class="n">user_id</span><span class="p">;</span>
</pre></div>
</div>
<p>Only the innermost queries returning sets of followers (which are the arguments
to <code class="docutils literal notranslate"><span class="pre">INTERSECT</span> <span class="pre">ALL</span></code>) have changed. We now select <code class="docutils literal notranslate"><span class="pre">target_user_id</span></code> and refer
to <code class="docutils literal notranslate"><span class="pre">source_user_id</span></code> in the WHERE clause, rather than the reverse.</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id3" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>“Friend” is Twitter’s term for the opposite of a follower: if user A
follows user B on Twitter, B is A’s friend and A is B’s follower.</p>
</aside>
<aside class="footnote brackets" id="id4" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>That is, of the two pairs (123, 456) and (456, 123) we only want one of
them, and so we arbitrarily pick the one in which the first element is
larger (<code class="docutils literal notranslate"><span class="pre">ut1.user_id</span> <span class="pre">&gt;</span> <span class="pre">ut2.user_id</span></code>). It’s “&gt;” rather than “&gt;=” because
there’s no reason to ask how many followers a user has in common with
themselves.</p>
</aside>
</aside>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="user-info.html" class="btn btn-neutral float-left" title="User-Level Information: Bio, Location, Etc." accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../apidocs.html" class="btn btn-neutral float-right" title="API Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Massachusetts Institute of Technology.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>